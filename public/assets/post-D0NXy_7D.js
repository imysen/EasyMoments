import{g as Ee,r as a,a as Se,b as o,j as e,B as d,C as b,e as _,c as re,d as ie,f as O,I as Ce,h as m,m as Te}from"./api-Djm3PB4m.js";import{u as Pe,T as Le}from"./use-config-DCEOYtYw.js";import{c as H,P as Oe,U as z,S as $}from"./page-shell-BZTC642n.js";import{h as le,a as de,H as ze,b as oe,c as $e,P as Me,d as M,E as Re,T as ce,r as me}from"./markdown-CoPZjDyY.js";import{v as R}from"./validators-BPggKWnM.js";import{X as He}from"./x-CT-hd4PJ.js";const Ie=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],Ae=H("arrow-left",Ie);const De=[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]],Fe=H("pencil",De);const Ue=[["path",{d:"M20 18v-2a4 4 0 0 0-4-4H4",key:"5vmcpk"}],["path",{d:"m9 17-5-5 5-5",key:"nvlc11"}]],Je=H("reply",Ue);function Ke(){const ue=Ee(),r=a.useMemo(()=>Se(),[ue]),{config:I}=Pe(),A=!!I?.turnstile_enabled,xe=I?.turnstile_site_key||"",[n,k]=a.useState(null),[E,he]=a.useState([]),[pe,S]=a.useState(!0),[D,C]=a.useState(""),[y,F]=a.useState(""),[N,T]=a.useState(null),[U,J]=a.useState(!1),[K,f]=a.useState(""),[B,P]=a.useState(""),[fe,q]=a.useState(0),[c,V]=a.useState(!1),[v,W]=a.useState(""),[u,X]=a.useState(""),[G,Q]=a.useState(!1),[Y,x]=a.useState(""),Z=a.useRef(null),[g,ge]=a.useState(!0),ee=a.useRef(null),[w,j]=a.useState(!1),se=a.useRef(null),[je,te]=a.useState([]);function ye(){const s=new URLSearchParams(window.location.search),t=s.get("id")||s.get("post_id");if(t&&/^\d+$/.test(t))return t;const i=window.location.pathname.match(/^\/posts\/(\d+)$/);if(i)return i[1];const l=window.location.pathname.match(/^\/post\/(\d+)$/);return l?l[1]:null}const h=ye(),L=r?.id??null,p=a.useCallback(async()=>{if(!h){C("帖子不存在"),S(!1);return}S(!0),C("");try{const s=L?`?user_id=${L}`:"",t=await o(`/posts/${h}${s}`),i=await o(`/posts/${h}/comments`);k(t),he(i),W(t.title),X(t.content)}catch(s){C(String(s?.message||s))}finally{S(!1)}},[h,L]);a.useEffect(()=>{p()},[p]),a.useEffect(()=>{o("/categories").then(s=>te(Array.isArray(s)?s:[])).catch(()=>te([]))},[]),a.useEffect(()=>{if(c)return;const s=Z.current;return s?(le(s),de(s)):void 0},[n,E.length,c]),a.useEffect(()=>{if(!c||!g)return;const s=ee.current;return s?(le(s),de(s)):void 0},[c,g,u]),a.useEffect(()=>{if(!w)return;function s(t){const i=t.target;if(!i)return;const l=se.current;l&&!l.contains(i)&&j(!1)}return document.addEventListener("mousedown",s),document.addEventListener("touchstart",s),()=>{document.removeEventListener("mousedown",s),document.removeEventListener("touchstart",s)}},[w]);function Ne(s){const t=[],i=new Map;return s.forEach(l=>i.set(l.id,{...l,replies:[]})),i.forEach(l=>{l.parent_id&&i.has(l.parent_id)?i.get(l.parent_id).replies.push(l):t.push(l)}),t}async function ve(){if(n){if(!r){window.location.href="/login";return}try{const s=await o(`/posts/${n.id}/like`,{method:"POST",headers:m("POST"),body:JSON.stringify({})});k(t=>t&&{...t,liked:s.liked,like_count:(t.like_count||0)+(s.liked?1:-1)})}catch{return}}}async function we(s){if(s.preventDefault(),!h)return;if(!r){window.location.href="/login";return}f("");const t=R(y,"评论");if(t)return f(t);if(y.length>3e3)return f("评论过长 (最多 3000 字符)");if(A&&!B)return f("请完成验证码验证");J(!0);try{await o(`/posts/${h}/comments`,{method:"POST",headers:m("POST"),body:JSON.stringify({content:y,parent_id:N?N.id:null,"cf-turnstile-response":B})}),F(""),T(null),P(""),q(i=>i+1),await p()}catch(i){f(String(i?.message||i)),P(""),q(l=>l+1)}finally{J(!1)}}async function ne(s){if(confirm("确定要删除此评论吗？此操作无法撤销。"))try{await o(`/comments/${s}`,{method:"DELETE",headers:m("DELETE")}),await p()}catch(t){alert(String(t?.message||t))}}async function be(){if(n&&confirm("确定要删除这个帖子吗？此操作无法撤销。"))try{const t=r?.role==="admin"?`/admin/posts/${n.id}`:`/posts/${n.id}`;await o(t,{method:"DELETE",headers:m("DELETE")}),window.location.href="/"}catch(s){alert(String(s?.message||s))}}async function _e(){if(n&&!(!r||r.role!=="admin"))try{const s=!n.is_pinned;await o(`/admin/posts/${n.id}/pin`,{method:"POST",headers:m("POST"),body:JSON.stringify({pinned:s})}),k(t=>t&&{...t,is_pinned:s?1:0})}catch{return}finally{j(!1)}}async function ae(s){if(n&&!(!r||r.role!=="admin"))try{await o(`/admin/posts/${n.id}/move`,{method:"POST",headers:m("POST"),body:JSON.stringify({category_id:s})}),j(!1),await p()}catch{return}}async function ke(){if(!n)return;x("");const s=R(v,"标题");if(s)return x(s);const t=R(u,"内容");if(t)return x(t);if(v.length>30)return x("标题过长 (最多 30 字符)");if(u.length>3e3)return x("内容过长 (最多 3000 字符)");Q(!0);try{await o(`/posts/${n.id}`,{method:"PUT",headers:m("PUT"),body:JSON.stringify({title:v,content:u,category_id:n.category_id})}),V(!1),await p()}catch(i){x(String(i?.message||i))}finally{Q(!1)}}return e.jsx(Oe,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx(d,{asChild:!0,variant:"ghost",size:"sm",children:e.jsxs("a",{href:"/",children:[e.jsx(Ae,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"返回首页"})]})})}),D?e.jsx("div",{className:"rounded-md border border-destructive/50 bg-destructive/5 p-3 text-sm text-destructive",children:D}):null,pe?e.jsx(b,{children:e.jsx(_,{className:"py-6 text-sm text-muted-foreground",children:"加载中..."})}):n?e.jsxs(e.Fragment,{children:[e.jsxs(b,{children:[e.jsx(re,{children:e.jsxs(ie,{className:"flex flex-col gap-2",children:[e.jsx("span",{children:n.title}),e.jsxs("span",{className:"flex flex-wrap items-center gap-x-2 gap-y-1 text-sm font-normal text-muted-foreground",children:[e.jsxs("span",{className:"inline-flex items-center gap-2",children:[n.author_avatar?e.jsx("img",{src:n.author_avatar,alt:"",className:"h-6 w-6 rounded-full object-cover",loading:"lazy",referrerPolicy:"no-referrer"}):e.jsx("span",{className:"inline-flex h-6 w-6 items-center justify-center rounded-full bg-muted text-[10px] text-muted-foreground",children:e.jsx(z,{className:"h-4 w-4"})}),e.jsx("span",{className:"text-foreground",children:n.author_name}),n.author_role==="admin"?e.jsxs("span",{className:"inline-flex items-center gap-1 rounded border border-indigo-500/30 bg-indigo-500/10 px-1.5 py-0.5 text-[10px] font-medium text-indigo-700 dark:text-indigo-300",children:[e.jsx($,{className:"h-3 w-3"}),e.jsx("span",{className:"sr-only",children:"管理员"})]}):null]}),e.jsx("span",{children:"·"}),e.jsx("span",{className:"whitespace-nowrap",children:O(n.created_at)})]})]})}),e.jsxs(_,{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs(d,{variant:n.liked?"secondary":"outline",size:"sm",onClick:ve,disabled:!r,children:[e.jsx(ze,{className:"h-4 w-4 text-rose-600",fill:n.liked?"currentColor":"none"}),e.jsx("span",{className:"tabular-nums",children:n.like_count||0}),e.jsx("span",{className:"sr-only",children:n.liked?"取消点赞":"点赞"})]}),e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-md border bg-muted/20 px-2 py-1 text-xs text-muted-foreground",children:[e.jsx(oe,{className:"h-4 w-4 text-emerald-600"}),e.jsx("span",{className:"tabular-nums",children:n.view_count||0}),e.jsx("span",{className:"sr-only",children:"观看数"})]}),r&&(r.role==="admin"||r.id===n.author_id)?e.jsx(e.Fragment,{children:e.jsxs(d,{variant:"outline",size:"sm",onClick:()=>V(s=>!s),children:[c?e.jsx(He,{className:"h-4 w-4"}):e.jsx(Fe,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:c?"取消编辑":"编辑"})]})}):null,r&&(r.role==="admin"||r.id===n.author_id)?e.jsxs("div",{className:"relative",ref:se,children:[e.jsxs(d,{type:"button",variant:"outline",size:"sm",onClick:()=>j(s=>!s),"aria-haspopup":"menu","aria-expanded":w,children:[e.jsx($e,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"更多"})]}),w?e.jsxs("div",{className:"absolute right-0 top-full z-50 mt-2 w-44 rounded-md border bg-background p-1 shadow-md",children:[r.role==="admin"?e.jsxs("button",{type:"button",className:"flex w-full items-center gap-2 rounded px-2 py-1.5 text-left text-sm hover:bg-muted",onClick:_e,children:[e.jsx(Me,{className:"h-4 w-4"}),n.is_pinned?"取消置顶":"置顶"]}):null,e.jsxs("button",{type:"button",className:"flex w-full items-center gap-2 rounded px-2 py-1.5 text-left text-sm text-destructive hover:bg-destructive/10",onClick:()=>{j(!1),be()},children:[e.jsx(M,{className:"h-4 w-4"}),"删除"]}),r.role==="admin"?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"my-1 h-px bg-border"}),e.jsx("div",{className:"px-2 py-1 text-xs font-medium text-muted-foreground",children:"移动到分类"}),e.jsx("button",{type:"button",className:"flex w-full items-center gap-2 rounded px-2 py-1.5 text-left text-sm hover:bg-muted",onClick:()=>void ae(null),children:"未分类"}),je.map(s=>e.jsx("button",{type:"button",className:"flex w-full items-center gap-2 rounded px-2 py-1.5 text-left text-sm hover:bg-muted",onClick:()=>void ae(s.id),children:s.name},s.id))]}):null]}):null]}):null]}),c?e.jsxs("div",{className:"space-y-3",children:[Y?e.jsx("div",{className:"rounded-md border border-destructive/50 bg-destructive/5 p-3 text-sm text-destructive",children:Y}):null,e.jsx("div",{className:"space-y-2",children:e.jsx(Ce,{value:v,onChange:s=>W(s.target.value),maxLength:30})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"flex items-center justify-end",children:e.jsxs(d,{type:"button",variant:"outline",size:"sm",onClick:()=>ge(s=>!s),children:[g?e.jsx(Re,{className:"h-4 w-4"}):e.jsx(oe,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:g?"关闭预览":"打开预览"})]})}),e.jsx(ce,{value:u,onChange:s=>X(s.target.value),rows:10})]}),g?e.jsxs("div",{className:"rounded-md border bg-muted/20 p-3",children:[e.jsx("div",{className:"mb-2 text-xs font-medium text-muted-foreground",children:"预览"}),e.jsx("div",{ref:ee,className:"prose max-w-none break-words [&_ul]:list-disc [&_ul]:pl-6 [&_ol]:list-decimal [&_ol]:pl-6 [&_li]:my-1",dangerouslySetInnerHTML:{__html:me(u||"")}})]}):null,e.jsx(d,{onClick:ke,disabled:G,children:G?"保存中...":"保存"})]}):e.jsx("div",{className:"prose max-w-none break-words [&_ul]:list-disc [&_ul]:pl-6 [&_ol]:list-decimal [&_ol]:pl-6 [&_li]:my-1",ref:Z,dangerouslySetInnerHTML:{__html:me(n.content||"")}})]})]}),e.jsxs(b,{children:[e.jsx(re,{children:e.jsx(ie,{children:"评论"})}),e.jsxs(_,{className:"space-y-4",children:[E.length===0?e.jsx("div",{className:"text-sm text-muted-foreground",children:"暂无评论"}):e.jsx("div",{className:"space-y-3",children:Ne(E).map(s=>e.jsxs("div",{className:"rounded-md border p-3",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-sm",children:e.jsxs("span",{className:"inline-flex items-center gap-2",children:[s.avatar_url?e.jsx("img",{src:s.avatar_url,alt:"",className:"h-6 w-6 rounded-full object-cover",loading:"lazy",referrerPolicy:"no-referrer"}):e.jsx("span",{className:"inline-flex h-6 w-6 items-center justify-center rounded-full bg-muted text-[10px] text-muted-foreground",children:e.jsx(z,{className:"h-4 w-4"})}),e.jsx("span",{className:"font-medium text-foreground",children:s.username}),s.role==="admin"?e.jsxs("span",{className:"inline-flex items-center gap-1 rounded border border-indigo-500/30 bg-indigo-500/10 px-1.5 py-0.5 text-[10px] font-medium text-indigo-700 dark:text-indigo-300",children:[e.jsx($,{className:"h-3 w-3"}),e.jsx("span",{className:"sr-only",children:"管理员"})]}):null,e.jsx("span",{className:"text-muted-foreground",children:O(s.created_at)})]})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(d,{variant:"ghost",size:"sm",onClick:()=>T(s),children:[e.jsx(Je,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"回复"})]}),r&&(r.role==="admin"||r.id===s.author_id)?e.jsxs(d,{variant:"ghost",size:"sm",onClick:()=>ne(s.id),children:[e.jsx(M,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"删除"})]}):null]})]}),e.jsx("div",{className:"mt-2 whitespace-pre-wrap text-sm",children:s.content}),s.replies&&s.replies.length?e.jsx("div",{className:"mt-3 space-y-2 border-l pl-3",children:s.replies.map(t=>e.jsxs("div",{className:"rounded-md bg-muted/30 p-2",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-xs",children:e.jsxs("span",{className:"inline-flex items-center gap-2",children:[t.avatar_url?e.jsx("img",{src:t.avatar_url,alt:"",className:"h-5 w-5 rounded-full object-cover",loading:"lazy",referrerPolicy:"no-referrer"}):e.jsx("span",{className:"inline-flex h-5 w-5 items-center justify-center rounded-full bg-muted text-[10px] text-muted-foreground",children:e.jsx(z,{className:"h-3.5 w-3.5"})}),e.jsx("span",{className:"font-medium text-foreground",children:t.username}),t.role==="admin"?e.jsxs("span",{className:"inline-flex items-center gap-1 rounded border border-indigo-500/30 bg-indigo-500/10 px-1 py-0.5 text-[10px] font-medium text-indigo-700 dark:text-indigo-300",children:[e.jsx($,{className:"h-3 w-3"}),e.jsx("span",{className:"sr-only",children:"管理员"})]}):null,e.jsx("span",{className:"text-muted-foreground",children:O(t.created_at)})]})}),r&&(r.role==="admin"||r.id===t.author_id)?e.jsxs(d,{variant:"ghost",size:"sm",onClick:()=>ne(t.id),children:[e.jsx(M,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"删除"})]}):null]}),e.jsx("div",{className:"mt-1 whitespace-pre-wrap text-sm",children:t.content})]},t.id))}):null]},s.id))}),N?e.jsxs("div",{className:"flex items-center justify-between rounded-md border bg-muted/30 p-2 text-sm",children:[e.jsxs("span",{children:["回复 ",e.jsx("span",{className:"font-medium",children:N.username})]}),e.jsx(d,{variant:"ghost",size:"sm",onClick:()=>T(null),children:"取消"})]}):null,e.jsxs("form",{className:"space-y-3",onSubmit:we,children:[K?e.jsx("div",{className:"rounded-md border border-destructive/50 bg-destructive/5 p-3 text-sm text-destructive",children:K}):null,e.jsx(ce,{value:y,onChange:s=>F(s.target.value),rows:4,placeholder:"写下你的评论..."}),e.jsx(Le,{enabled:A,siteKey:xe,onToken:P,resetKey:fe}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(d,{type:"submit",disabled:U,children:U?"发布中...":"发布评论"}),r?null:e.jsx(d,{type:"button",variant:"outline",onClick:()=>window.location.href="/login",children:"登录后评论"})]})]})]})]})]}):e.jsx(b,{children:e.jsx(_,{className:"py-6 text-sm text-muted-foreground",children:"帖子不存在"})})]})})}Te("root",e.jsx(Ke,{}));
