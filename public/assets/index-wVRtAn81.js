import{g as Re,r as t,a as ze,b as C,j as e,I as H,B as l,C as k,c as De,d as Ae,e as P,f as Ue,h as I,m as Fe}from"./api-Djm3PB4m.js";import{u as He,T as qe}from"./use-config-DCEOYtYw.js";import{c as N,P as Be,U as Je,S as Ke}from"./page-shell-BZTC642n.js";import{L as q}from"./label-DIN_m3m4.js";import{h as Qe,a as Ve,E as We,b as ge,T as Xe,r as Ge,P as je,c as Ye,d as Ze,H as es}from"./markdown-CoPZjDyY.js";import{v as ye}from"./validators-BPggKWnM.js";import{X as ss}from"./x-CT-hd4PJ.js";import{R as ts}from"./refresh-cw-B4TJ-5nR.js";const ns=[["path",{d:"m6 9 6 6 6-6",key:"qrunsl"}]],as=N("chevron-down",ns);const rs=[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]],is=N("chevron-left",rs);const ls=[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]],os=N("chevron-right",ls);const cs=[["path",{d:"m18 15-6-6-6 6",key:"153udz"}]],ds=N("chevron-up",cs);const ms=[["path",{d:"M2.992 16.342a2 2 0 0 1 .094 1.167l-1.065 3.29a1 1 0 0 0 1.236 1.168l3.413-.998a2 2 0 0 1 1.099.092 10 10 0 1 0-4.777-4.719",key:"1sd12s"}]],us=N("message-circle",ms);const hs=[["path",{d:"m21 21-4.34-4.34",key:"14j7rj"}],["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}]],xs=N("search",hs);function ps(){const{config:B}=He(),ve=Re(),c=t.useMemo(()=>ze(),[ve]),[J,K]=t.useState(""),[O,Q]=t.useState([]),[T,Ne]=t.useState(""),[L,V]=t.useState(""),[E,W]=t.useState(""),[X,be]=t.useState([]),[we,Se]=t.useState(0),[d,b]=t.useState(0),[o,G]=t.useState(!0),[Y,Z]=t.useState(""),x=10,[ee,se]=t.useState(""),[$,te]=t.useState(""),[g,ne]=t.useState(""),[R,ae]=t.useState(""),[w,_e]=t.useState(!0),[z,re]=t.useState(!1),[ie,le]=t.useState(!1),[oe,p]=t.useState(""),[ce,D]=t.useState(""),[Ce,de]=t.useState(0),me=t.useRef(null),[A,S]=t.useState(null),[ke,j]=t.useState(null),[y,Pe]=t.useState("time_desc"),ue=t.useRef(null),U=t.useRef(null),he=!!B?.turnstile_enabled,Te=B?.turnstile_site_key||"",xe=t.useCallback(async()=>{try{const s=await C("/categories");Q(s)}catch{Q([])}},[]),i=t.useCallback(async s=>{G(!0),Z("");try{const n=y==="likes_desc"?"likes":y==="comments_desc"?"comments":y==="views_desc"?"views":"time",r=y==="time_asc"?"asc":"desc",m=T?`&category_id=${encodeURIComponent(T)}`:"",u=E?`&q=${encodeURIComponent(E)}`:"",a=`&sort_by=${encodeURIComponent(n)}&sort_dir=${encodeURIComponent(r)}`,M=await fetch(`/api/posts?limit=${x}&offset=${s}${m}${u}${a}`);if(!M.ok)throw new Error("加载帖子失败");const _=await M.json(),fe=Array.isArray(_)?_:_.posts,Oe=Array.isArray(_)?fe.length:Number(_.total||0),Le=fe.map(F=>({...F,like_count:F.like_count||0,comment_count:F.comment_count||0}));be(Le),Se(Oe),b(s)}catch(n){Z(String(n?.message||n))}finally{G(!1)}},[T,E,y]);t.useEffect(()=>{xe()},[xe]),t.useEffect(()=>{i(0)},[i]),t.useEffect(()=>{const s=new URLSearchParams(window.location.search);s.get("verified")==="true"?(K("邮箱验证成功，现在可以登录。"),s.delete("verified"),window.history.replaceState({},document.title,`${window.location.pathname}${s.toString()?`?${s.toString()}`:""}`)):s.get("email_changed")==="true"&&(K("邮箱更换成功。"),s.delete("email_changed"),window.history.replaceState({},document.title,`${window.location.pathname}${s.toString()?`?${s.toString()}`:""}`))},[]),t.useEffect(()=>{if(!w)return;const s=me.current;return s?(Qe(s),Ve(s)):void 0},[w,g]),t.useEffect(()=>{if(A==null)return;function s(){S(null)}return document.addEventListener("mousedown",s),document.addEventListener("touchstart",s),()=>{document.removeEventListener("mousedown",s),document.removeEventListener("touchstart",s)}},[A]),t.useEffect(()=>{U.current!==null&&U.current!==d&&!o&&ue.current?.scrollIntoView({behavior:"smooth",block:"start"}),U.current=d},[d,o]);async function Ee(s){if(!(!c||c.role!=="admin")){j(s.id);try{const n=!s.is_pinned;await C(`/admin/posts/${s.id}/pin`,{method:"POST",headers:I("POST"),body:JSON.stringify({pinned:n})}),S(null),await i(d)}catch{return}finally{j(null)}}}async function $e(s){if(!(!c||c.role!=="admin")&&confirm("确定要删除这个帖子吗？此操作无法撤销。")){j(s.id);try{await C(`/admin/posts/${s.id}`,{method:"DELETE",headers:I("DELETE")}),S(null),await i(d)}catch{return}finally{j(null)}}}async function pe(s,n){if(!(!c||c.role!=="admin")){j(s.id);try{await C(`/admin/posts/${s.id}/move`,{method:"POST",headers:I("POST"),body:JSON.stringify({category_id:n})}),S(null),await i(d)}catch{return}finally{j(null)}}}async function Me(s){if(s.preventDefault(),!c){window.location.href="/login";return}p("");const n=ye($,"标题");if(n)return p(n);const r=ye(g,"内容");if(r)return p(r);if($.length>30)return p("标题过长 (最多 30 字符)");if(g.length>3e3)return p("内容过长 (最多 3000 字符)");if(he&&!ce)return p("请完成验证码验证");le(!0);try{await C("/posts",{method:"POST",headers:I("POST"),body:JSON.stringify({title:$,content:g,category_id:R?Number(R):null,"cf-turnstile-response":ce})}),te(""),ne(""),ae(""),D(""),de(m=>m+1),re(!1),await i(0)}catch(m){p(String(m?.message||m)),D(""),de(u=>u+1)}finally{le(!1)}}const v=Math.floor(d/x)+1,h=Math.max(1,Math.ceil(we/x)),f=[];if(h<=7)for(let s=1;s<=h;s++)f.push(s);else{const s=Math.max(2,v-2),n=Math.min(h-1,v+2);f.push(1),s>2&&f.push("ellipsis");for(let r=s;r<=n;r++)f.push(r);n<h-1&&f.push("ellipsis"),f.push(h)}function Ie(s){const n=s.match(/!\[[^\]]*\]\((https?:\/\/[^)\s]+|\/[^)\s]+)\)/i);return n?.[1]?n[1]:s.match(/<img[^>]+src=["']([^"']+)["']/i)?.[1]||""}return e.jsx(Be,{children:e.jsxs("div",{className:"space-y-6",children:[J?e.jsx("div",{className:"rounded-md border bg-muted/40 p-3 text-sm",children:J}):null,e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-semibold tracking-tight",children:"D1 Forum"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"基于 shadcn/ui + Tailwind 的多页应用（非 SPA），由 Cloudflare Workers 在边缘统一提供静态页面与 API。"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm text-muted-foreground",htmlFor:"category-filter",children:"分类"}),e.jsxs("select",{id:"category-filter",className:"h-9 rounded-md border bg-background px-3 text-sm",value:T,onChange:s=>{Ne(s.target.value),b(0)},children:[e.jsx("option",{value:"",children:"全部"}),e.jsx("option",{value:"uncategorized",children:"未分类"}),O.map(s=>e.jsx("option",{value:String(s.id),children:s.name},s.id))]}),e.jsx("label",{className:"text-sm text-muted-foreground",htmlFor:"sort-filter",children:"排序"}),e.jsxs("select",{id:"sort-filter",className:"h-9 rounded-md border bg-background px-3 text-sm",value:y,onChange:s=>{Pe(s.target.value),b(0)},children:[e.jsx("option",{value:"time_desc",children:"最新发布"}),e.jsx("option",{value:"time_asc",children:"最早发布"}),e.jsx("option",{value:"likes_desc",children:"最多点赞"}),e.jsx("option",{value:"comments_desc",children:"最多评论"}),e.jsx("option",{value:"views_desc",children:"最多观看"})]}),e.jsxs("form",{className:"flex items-center gap-2",onSubmit:s=>{s.preventDefault(),b(0),W(L.trim())},children:[e.jsx(H,{value:L,onChange:s=>V(s.target.value),placeholder:"搜索标题/内容",className:"h-9 w-48"}),e.jsxs(l,{variant:"outline",size:"sm",type:"submit",disabled:o,children:[e.jsx(xs,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"搜索"})]}),L||E?e.jsxs(l,{variant:"outline",size:"sm",type:"button",onClick:()=>{V(""),W(""),b(0)},disabled:o,children:[e.jsx(ss,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"清除"})]}):null]}),e.jsxs(l,{variant:"outline",size:"sm",onClick:()=>i(0),disabled:o,children:[e.jsx(ts,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"刷新"})]})]})]}),c?e.jsxs(k,{children:[e.jsx(De,{children:e.jsxs(Ae,{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{children:"发布新帖"}),e.jsxs(l,{type:"button",variant:"outline",size:"sm",onClick:()=>re(s=>!s),children:[z?e.jsx(ds,{className:"h-4 w-4"}):e.jsx(as,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:z?"收起":"展开"})]})]})}),e.jsx(P,{children:z?e.jsxs("form",{className:"space-y-4",onSubmit:Me,children:[oe?e.jsx("div",{className:"rounded-md border border-destructive/50 bg-destructive/5 p-3 text-sm text-destructive",children:oe}):null,e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"new-title",children:"标题"}),e.jsx(H,{id:"new-title",maxLength:30,value:$,onChange:s=>te(s.target.value),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"new-category",children:"分类 (可选)"}),e.jsxs("select",{id:"new-category",className:"h-9 w-full rounded-md border bg-background px-3 text-sm",value:R,onChange:s=>ae(s.target.value),children:[e.jsx("option",{value:"",children:"无分类"}),O.map(s=>e.jsx("option",{value:String(s.id),children:s.name},s.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx(q,{htmlFor:"new-content",children:"内容 (支持 Markdown)"}),e.jsxs(l,{type:"button",variant:"outline",size:"sm",onClick:()=>_e(s=>!s),children:[w?e.jsx(We,{className:"h-4 w-4"}):e.jsx(ge,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:w?"关闭预览":"打开预览"})]})]}),e.jsx(Xe,{id:"new-content",value:g,onChange:s=>ne(s.target.value),rows:8,required:!0})]}),w?e.jsxs("div",{className:"rounded-md border bg-muted/20 p-3",children:[e.jsx("div",{className:"mb-2 text-xs font-medium text-muted-foreground",children:"预览"}),e.jsx("div",{ref:me,className:"prose max-w-none break-words [&_ul]:list-disc [&_ul]:pl-6 [&_ol]:list-decimal [&_ol]:pl-6 [&_li]:my-1",dangerouslySetInnerHTML:{__html:Ge(g||"")}})]}):null,e.jsx(qe,{enabled:he,siteKey:Te,onToken:D,resetKey:Ce}),e.jsx(l,{type:"submit",disabled:ie,children:ie?"发布中...":"发布"})]}):e.jsx("div",{className:"text-sm text-muted-foreground",children:"点击右侧按钮展开编辑器。"})})]}):e.jsx(k,{children:e.jsxs(P,{className:"py-6 text-sm text-muted-foreground",children:[e.jsx("a",{className:"text-foreground underline",href:"/login",children:"登录"})," ","后可发布、点赞和评论。"]})}),Y?e.jsx("div",{className:"rounded-md border border-destructive/50 bg-destructive/5 p-3 text-sm text-destructive",children:Y}):null,e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{ref:ue}),o?e.jsx(k,{children:e.jsx(P,{className:"py-6 text-sm text-muted-foreground",children:"加载中..."})}):X.length===0?e.jsx(k,{children:e.jsx(P,{className:"py-6 text-sm text-muted-foreground",children:"暂无帖子"})}):X.map(s=>{const n=Ie(s.content||""),r=c?.role==="admin",m=A===s.id,u=ke===s.id;return e.jsx(k,{children:e.jsx(P,{className:"py-5",children:e.jsxs("div",{className:"flex gap-4",children:[n?e.jsx("img",{src:n,alt:"",className:"h-20 w-28 shrink-0 rounded-md object-cover",loading:"lazy",referrerPolicy:"no-referrer"}):null,e.jsxs("div",{className:"min-w-0 flex-1 space-y-1",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex min-w-0 items-center gap-2",children:[s.is_pinned?e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full border border-amber-500/30 bg-amber-500/10 px-2 py-0.5 text-xs font-medium text-amber-700 dark:text-amber-300",children:[e.jsx(je,{className:"h-3.5 w-3.5"}),"置顶"]}):null,e.jsx("a",{className:"truncate text-lg font-semibold hover:underline",href:`/posts/${s.id}`,children:s.title})]}),r?e.jsxs("div",{className:"relative",children:[e.jsxs(l,{type:"button",variant:"ghost",size:"sm",disabled:u,onMouseDown:a=>a.stopPropagation(),onTouchStart:a=>a.stopPropagation(),onClick:a=>{a.preventDefault(),a.stopPropagation(),S(M=>M===s.id?null:s.id)},"aria-haspopup":"menu","aria-expanded":m,children:[e.jsx(Ye,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"更多"})]}),m?e.jsxs("div",{className:"absolute right-0 top-full z-50 mt-1 w-40 rounded-md border bg-background p-1 shadow-md",onMouseDown:a=>a.stopPropagation(),onTouchStart:a=>a.stopPropagation(),onClick:a=>a.stopPropagation(),children:[e.jsxs("button",{type:"button",disabled:u,className:"flex w-full items-center gap-2 rounded px-2 py-1.5 text-left text-sm hover:bg-muted disabled:opacity-50",onClick:()=>void Ee(s),children:[e.jsx(je,{className:"h-4 w-4"}),s.is_pinned?"取消置顶":"置顶"]}),e.jsxs("button",{type:"button",disabled:u,className:"flex w-full items-center gap-2 rounded px-2 py-1.5 text-left text-sm text-destructive hover:bg-destructive/10 disabled:opacity-50",onClick:()=>void $e(s),children:[e.jsx(Ze,{className:"h-4 w-4"}),"删除"]}),e.jsx("div",{className:"my-1 h-px bg-border"}),e.jsx("div",{className:"px-2 py-1 text-xs font-medium text-muted-foreground",children:"移动到分类"}),e.jsx("button",{type:"button",disabled:u,className:"flex w-full items-center gap-2 rounded px-2 py-1.5 text-left text-sm hover:bg-muted disabled:opacity-50",onClick:()=>void pe(s,null),children:"未分类"}),O.map(a=>e.jsx("button",{type:"button",disabled:u,className:"flex w-full items-center gap-2 rounded px-2 py-1.5 text-left text-sm hover:bg-muted disabled:opacity-50",onClick:()=>void pe(s,a.id),children:a.name},a.id))]}):null]}):null]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-x-2 gap-y-1 text-sm text-muted-foreground",children:[e.jsxs("span",{className:"inline-flex items-center gap-2",children:[s.author_avatar?e.jsx("img",{src:s.author_avatar,alt:"",className:"h-6 w-6 rounded-full object-cover",loading:"lazy",referrerPolicy:"no-referrer"}):e.jsx("span",{className:"inline-flex h-6 w-6 items-center justify-center rounded-full bg-muted text-[10px] text-muted-foreground",children:e.jsx(Je,{className:"h-4 w-4"})}),e.jsx("span",{className:"truncate text-foreground",children:s.author_name}),s.author_role==="admin"?e.jsxs("span",{className:"inline-flex items-center gap-1 rounded border border-indigo-500/30 bg-indigo-500/10 px-1.5 py-0.5 text-[10px] font-medium text-indigo-700 dark:text-indigo-300",children:[e.jsx(Ke,{className:"h-3 w-3"}),e.jsx("span",{className:"sr-only",children:"管理员"})]}):null]}),s.category_name?e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"·"}),e.jsx("span",{className:"truncate",children:s.category_name})]}):null,e.jsx("span",{children:"·"}),e.jsx("span",{className:"whitespace-nowrap",children:Ue(s.created_at)})]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-muted-foreground",children:[e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(es,{className:"h-4 w-4 text-rose-600"}),s.like_count||0]}),e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(us,{className:"h-4 w-4 text-sky-600"}),s.comment_count||0]}),e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(ge,{className:"h-4 w-4 text-emerald-600"}),s.view_count||0]})]})]})]})})},s.id)})]}),e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(l,{variant:"outline",size:"sm",disabled:v<=1||o,onClick:()=>i(Math.max(0,d-x)),children:[e.jsx(is,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"上一页"})]}),e.jsx("div",{className:"flex items-center gap-1",children:f.map((s,n)=>s==="ellipsis"?e.jsx("span",{className:"px-2 text-sm text-muted-foreground",children:"…"},`e-${n}`):e.jsx(l,{variant:s===v?"secondary":"outline",size:"sm",disabled:o,onClick:()=>i((s-1)*x),children:s},s))}),e.jsxs(l,{variant:"outline",size:"sm",disabled:v>=h||o,onClick:()=>i(d+x),children:[e.jsx(os,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"下一页"})]})]}),e.jsxs("form",{className:"flex items-center gap-2",onSubmit:s=>{s.preventDefault();const n=Number.parseInt(ee,10);if(!Number.isFinite(n))return;const r=Math.min(Math.max(n,1),h);se(String(r)),i((r-1)*x)},children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["第 ",v," / ",h," 页"]}),e.jsx(H,{value:ee,onChange:s=>se(s.target.value),inputMode:"numeric",placeholder:"跳页",className:"h-9 w-20"}),e.jsx(l,{variant:"outline",size:"sm",type:"submit",disabled:o,children:"跳转"})]})]})]})})}Fe("root",e.jsx(ps,{}));
